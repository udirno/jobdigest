---
phase: 02-resume-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/pdf.min.mjs
  - src/lib/pdf.worker.min.mjs
  - src/lib/mammoth.browser.min.js
  - src/resume-parser.js
  - src/storage.js
autonomous: true

must_haves:
  truths:
    - "PDF.js and mammoth.js libraries are vendored in src/lib/ and loadable"
    - "Resume parser can extract text from a PDF ArrayBuffer"
    - "Resume parser can extract text from a DOCX ArrayBuffer"
    - "Storage has getResume/setResume/clearResume helper methods"
  artifacts:
    - path: "src/lib/pdf.min.mjs"
      provides: "PDF.js main library for PDF text extraction"
    - path: "src/lib/pdf.worker.min.mjs"
      provides: "PDF.js web worker for background PDF processing"
    - path: "src/lib/mammoth.browser.min.js"
      provides: "mammoth.js browser bundle for DOCX text extraction"
    - path: "src/resume-parser.js"
      provides: "Unified resume processing module"
      exports: ["processResumeFile", "readFileAsArrayBuffer", "validateFile"]
    - path: "src/storage.js"
      provides: "Resume storage helpers added to existing storage abstraction"
  key_links:
    - from: "src/resume-parser.js"
      to: "src/lib/pdf.min.mjs"
      via: "ES module import"
      pattern: "import.*pdf\\.min\\.mjs"
    - from: "src/resume-parser.js"
      to: "window.mammoth"
      via: "global reference (loaded via script tag)"
      pattern: "window\\.mammoth|mammoth\\.extractRawText"
---

<objective>
Set up resume file processing infrastructure: vendor PDF.js and mammoth.js libraries, create a unified resume-parser.js module that extracts text from PDF and DOCX files, and extend storage.js with resume helper methods.

Purpose: Provide the processing backbone that the resume UI (Plan 02) will wire into. Separating library setup and parsing logic from UI ensures the parser can be tested independently and keeps Plan 02 focused on UX.

Output: Three vendored library files in src/lib/, a resume-parser.js module with file validation and text extraction, and getResume/setResume/clearResume methods in storage.js.
</objective>

<execution_context>
@/Users/udirno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/udirno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-resume-management/02-RESEARCH.md
@src/storage.js
@manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vendor PDF.js and mammoth.js libraries</name>
  <files>src/lib/pdf.min.mjs, src/lib/pdf.worker.min.mjs, src/lib/mammoth.browser.min.js</files>
  <action>
Create `src/lib/` directory and download the three library files:

1. **PDF.js v5.4.624** - Download the pre-built ESM distribution files:
   - `pdf.min.mjs` from https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.624/build/pdf.min.mjs
   - `pdf.worker.min.mjs` from https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.624/build/pdf.worker.min.mjs

   Use `curl` to download. These are the official Mozilla PDF.js pre-built files from npm via jsDelivr CDN.

2. **mammoth.js v1.8.0** (latest stable) - Download the browser bundle:
   - `mammoth.browser.min.js` from https://cdn.jsdelivr.net/npm/mammoth@1.8.0/mammoth.browser.min.js

   This is the UMD browser bundle that exposes `window.mammoth` when loaded via script tag.

If any download fails (404, network error), try alternate CDN (unpkg.com) with same paths:
- https://unpkg.com/pdfjs-dist@5.4.624/build/pdf.min.mjs
- https://unpkg.com/pdfjs-dist@5.4.624/build/pdf.worker.min.mjs
- https://unpkg.com/mammoth@1.8.0/mammoth.browser.min.js

If v5.4.624 of pdfjs-dist is not found, check latest version at https://www.npmjs.com/package/pdfjs-dist and use the latest v4.x or v5.x stable release instead. Similarly for mammoth, if v1.8.0 is unavailable, use latest v1.x.

Verify each file is non-empty and contains JavaScript (not an HTML error page).
  </action>
  <verify>
All three files exist and are non-empty:
- `ls -la src/lib/pdf.min.mjs` (should be > 100KB)
- `ls -la src/lib/pdf.worker.min.mjs` (should be > 100KB)
- `ls -la src/lib/mammoth.browser.min.js` (should be > 50KB)
- `head -c 100 src/lib/pdf.min.mjs` (should show JavaScript, not HTML)
- `head -c 100 src/lib/mammoth.browser.min.js` (should show JavaScript, not HTML)
  </verify>
  <done>Three library files vendored in src/lib/, each containing valid JavaScript of expected size.</done>
</task>

<task type="auto">
  <name>Task 2: Create resume-parser.js and extend storage.js</name>
  <files>src/resume-parser.js, src/storage.js</files>
  <action>
**Create `src/resume-parser.js`:**

This module provides file validation and text extraction for PDF and DOCX resumes. It runs in the popup context where both DOM and Web Workers are available.

Export the following functions:

1. `validateFile(file)` - Validates a File object before processing:
   - Check file exists and has size > 0
   - Check file size <= 5MB (5 * 1024 * 1024 bytes). If over, throw Error: "File too large. Please upload a resume under 5MB."
   - Check file extension is .pdf or .docx (extract from file.name, case-insensitive). If invalid, throw Error: "Unsupported file format. Please upload a PDF or DOCX file."
   - Return the lowercase extension string ('pdf' or 'docx')

2. `readFileAsArrayBuffer(file)` - Wraps FileReader in a Promise:
   - Create new FileReader
   - Return promise that resolves with ArrayBuffer on reader.onload
   - Rejects with Error("Failed to read file") on reader.onerror
   - Calls reader.readAsArrayBuffer(file)

3. `extractTextFromPDF(arrayBuffer)` - Extracts text using PDF.js:
   - Import PDF.js: `import * as pdfjsLib from './lib/pdf.min.mjs';`
   - Set worker path: `pdfjsLib.GlobalWorkerOptions.workerSrc = chrome.runtime.getURL('src/lib/pdf.worker.min.mjs');`
     (Use chrome.runtime.getURL for reliable path resolution in extension context)
   - Load document: `const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;`
   - Loop through pages 1 to pdf.numPages
   - For each page: `getPage(pageNum)` then `getTextContent()` then map `items` to `.str` joined with spaces
   - Concatenate pages with `\n\n` separator
   - Return trimmed text
   - Wrap in try-catch: on error, throw Error("Failed to extract text from PDF. The file may be corrupted or password-protected.")

4. `extractTextFromDOCX(arrayBuffer)` - Extracts text using mammoth.js:
   - Access mammoth via `window.mammoth` (loaded by script tag in popup.html)
   - Call `window.mammoth.extractRawText({ arrayBuffer: arrayBuffer })`
   - Log any result.messages as warnings
   - Return `result.value` (plain text)
   - Wrap in try-catch: on error, throw Error("Failed to extract text from DOCX. The file may be corrupted or unsupported.")

5. `processResumeFile(file)` - Main entry point combining validation, reading, and extraction:
   - Call `validateFile(file)` to get file type
   - Call `readFileAsArrayBuffer(file)` to get ArrayBuffer
   - Based on file type, call `extractTextFromPDF` or `extractTextFromDOCX`
   - Validate extracted text: if null/empty or trimmed length < 50, throw Error("Could not extract enough text from file. Please try a different format or paste your resume text directly.")
   - Return object: `{ text: extractedText.trim(), fileName: file.name, uploadedAt: new Date().toISOString() }`

**Extend `src/storage.js`:**

Add three methods to the existing `storage` object (before the closing `};`):

1. `async getResume()` - Returns `await this.get(STORAGE_KEYS.RESUME)` (returns null if no resume)

2. `async setResume(resume)` - Calls `await this.set(STORAGE_KEYS.RESUME, resume)`. Parameter is `{ text: string, fileName: string, uploadedAt: string }`.

3. `async clearResume()` - Calls `await this.set(STORAGE_KEYS.RESUME, null)`.

These follow the exact same pattern as existing helpers (getApiKeys, getOnboarding, etc.).
  </action>
  <verify>
- `grep -n "processResumeFile\|extractTextFromPDF\|extractTextFromDOCX\|validateFile\|readFileAsArrayBuffer" src/resume-parser.js` shows all 5 exported functions
- `grep -n "getResume\|setResume\|clearResume" src/storage.js` shows all 3 new methods
- `grep "5 \* 1024 \* 1024" src/resume-parser.js` confirms 5MB file size limit
- `grep "chrome.runtime.getURL" src/resume-parser.js` confirms proper worker path resolution
- No syntax errors: the file uses proper `export` keywords and `async/await` patterns
  </verify>
  <done>
resume-parser.js exports processResumeFile (unified entry point), validateFile, readFileAsArrayBuffer, extractTextFromPDF, extractTextFromDOCX. storage.js has getResume, setResume, clearResume methods following existing patterns. File validation enforces 5MB limit and PDF/DOCX only.
  </done>
</task>

</tasks>

<verification>
1. `ls src/lib/` shows pdf.min.mjs, pdf.worker.min.mjs, mammoth.browser.min.js
2. `grep "export" src/resume-parser.js` shows exported functions
3. `grep "getResume\|setResume\|clearResume" src/storage.js` shows new storage helpers
4. No import errors: resume-parser.js imports from './lib/pdf.min.mjs' (relative path, file exists)
5. Worker path uses chrome.runtime.getURL for reliable resolution in extension context
</verification>

<success_criteria>
- Three vendor libraries exist in src/lib/ with valid JavaScript content
- resume-parser.js provides complete file processing pipeline (validate -> read -> extract -> return)
- storage.js extended with getResume/setResume/clearResume following existing patterns
- File validation rejects files over 5MB and non-PDF/DOCX formats
- PDF extraction uses chrome.runtime.getURL for worker path
- DOCX extraction references window.mammoth (loaded separately via script tag)
</success_criteria>

<output>
After completion, create `.planning/phases/02-resume-management/02-01-SUMMARY.md`
</output>
