---
phase: 03-job-fetching-scheduling
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - src/settings.js
  - src/popup.js
  - src/popup.html
  - src/popup.css
autonomous: false

must_haves:
  truths:
    - "User can set their preferred daily fetch time via settings UI"
    - "User can manually trigger job fetch via 'Fetch Jobs Now' button"
    - "User can see next scheduled fetch time in settings"
    - "User can configure search preferences (keywords, location, salary, date posted, employment type, remote)"
    - "Fetch Jobs Now button shows progress during fetch and disables to prevent double-trigger"
    - "Daily cap status is visible (e.g., '42/100 jobs fetched today')"
  artifacts:
    - path: "src/settings.js"
      provides: "Fetch scheduling UI, search preferences UI, manual trigger button, fetch status display"
      contains: "Fetch Jobs Now"
    - path: "src/popup.js"
      provides: "Fetch status display in main view header"
      contains: "GET_FETCH_STATUS"
  key_links:
    - from: "src/settings.js"
      to: "src/background.js"
      via: "chrome.runtime.sendMessage TRIGGER_FETCH"
      pattern: "type.*TRIGGER_FETCH"
    - from: "src/settings.js"
      to: "src/background.js"
      via: "chrome.runtime.sendMessage UPDATE_FETCH_SCHEDULE"
      pattern: "type.*UPDATE_FETCH_SCHEDULE"
    - from: "src/settings.js"
      to: "src/storage.js"
      via: "storage.setSettings for search preferences"
      pattern: "storage\\.setSettings"
    - from: "src/popup.js"
      to: "src/background.js"
      via: "chrome.runtime.sendMessage GET_FETCH_STATUS"
      pattern: "type.*GET_FETCH_STATUS"
---

<objective>
Add fetch scheduling controls, search preference configuration, and manual fetch trigger to the settings panel. Update the main popup view to show fetch status. This gives users control over when and what jobs are fetched, plus the ability to trigger an immediate fetch.

Purpose: This completes the user-facing side of Phase 3. Users need to configure their fetch time, set search preferences (keywords, location, salary), trigger manual fetches, and see the status of their daily job fetching.

Output: Updated settings panel with three new sections (Fetch Schedule, Search Preferences, Manual Fetch), updated popup header with fetch status indicator.
</objective>

<execution_context>
@/Users/udirno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/udirno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-job-fetching-scheduling/03-CONTEXT.md
@src/settings.js
@src/popup.js
@src/popup.html
@src/popup.css
@src/storage.js
@.planning/phases/03-job-fetching-scheduling/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fetch scheduling and search preferences to settings panel</name>
  <files>src/settings.js, src/popup.css</files>
  <action>
Modify `src/settings.js` to add three new sections to the settings panel HTML. Read the current file first.

**Add these sections AFTER the Resume section and BEFORE the API Keys section** in the `initSettings` function's template literal:

**Section 1: Job Fetching**
```html
<!-- Job Fetching Section -->
<div class="settings-section">
  <h3 class="section-title">Job Fetching</h3>
  <p class="section-description">Configure when jobs are fetched automatically.</p>

  <!-- Fetch time -->
  <div class="setting-row">
    <label class="setting-label">Daily fetch time</label>
    <div class="time-picker">
      <select id="fetch-hour" class="settings-select">
        <!-- Options 0-23, populated by JS -->
      </select>
      <span>:</span>
      <select id="fetch-minute" class="settings-select">
        <option value="0">00</option>
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="45">45</option>
      </select>
    </div>
  </div>

  <!-- Next fetch display -->
  <div class="setting-row">
    <span class="setting-label">Next fetch</span>
    <span id="next-fetch-time" class="setting-value">Loading...</span>
  </div>

  <!-- Daily stats -->
  <div class="setting-row">
    <span class="setting-label">Today's jobs</span>
    <span id="daily-cap-status" class="setting-value">Loading...</span>
  </div>

  <!-- Fetch history (last 5) -->
  <div class="fetch-history" id="fetch-history">
    <span class="setting-label">Recent fetches</span>
    <div id="fetch-history-list" class="history-list">Loading...</div>
  </div>

  <!-- Manual trigger button -->
  <div class="actions" style="margin-top: 12px;">
    <button type="button" id="fetch-now-btn" class="btn-primary">Fetch Jobs Now</button>
    <div class="status-indicator" id="fetch-now-status"></div>
  </div>
</div>
```

**Section 2: Search Preferences**
```html
<!-- Search Preferences Section -->
<div class="settings-section">
  <h3 class="section-title">Search Preferences</h3>
  <p class="section-description">Customize what jobs to search for.</p>

  <div class="setting-row">
    <label class="setting-label" for="search-keywords">Keywords / Job Titles</label>
    <input type="text" id="search-keywords" class="settings-input" placeholder="e.g., software engineer, frontend developer" value="">
    <span class="input-hint">Comma-separated keywords</span>
  </div>

  <div class="setting-row">
    <label class="setting-label" for="search-location">Location</label>
    <input type="text" id="search-location" class="settings-input" placeholder="e.g., San Francisco, CA" value="">
  </div>

  <div class="setting-row">
    <label class="setting-label" for="search-salary-min">Minimum Salary</label>
    <input type="number" id="search-salary-min" class="settings-input" placeholder="e.g., 100000" value="">
    <span class="input-hint">Annual salary in USD (optional)</span>
  </div>

  <div class="setting-row">
    <label class="setting-label" for="search-date-posted">Date Posted</label>
    <select id="search-date-posted" class="settings-select">
      <option value="all">Any time</option>
      <option value="today">Today</option>
      <option value="3days">Last 3 days</option>
      <option value="week">Last week</option>
      <option value="month">Last month</option>
    </select>
  </div>

  <div class="setting-row">
    <label class="setting-label" for="search-employment-type">Employment Type</label>
    <select id="search-employment-type" class="settings-select">
      <option value="FULLTIME">Full-time</option>
      <option value="PARTTIME">Part-time</option>
      <option value="CONTRACTOR">Contract</option>
      <option value="FULLTIME,PARTTIME,CONTRACTOR">All types</option>
    </select>
  </div>

  <div class="setting-row checkbox-row">
    <input type="checkbox" id="search-remote-only">
    <label for="search-remote-only" class="setting-label">Remote jobs only</label>
  </div>

  <div class="actions">
    <button type="button" id="save-search-btn" class="btn-primary btn-sm">Save Search Preferences</button>
    <div class="status-indicator" id="search-save-status"></div>
  </div>
</div>
```

**Populate hour selector** in `initSettings` after rendering the HTML:
```javascript
// Populate hour options (0-23)
const hourSelect = container.querySelector('#fetch-hour');
for (let h = 0; h < 24; h++) {
  const opt = document.createElement('option');
  opt.value = h;
  opt.textContent = h === 0 ? '12 AM' : h < 12 ? `${h} AM` : h === 12 ? '12 PM' : `${h - 12} PM`;
  hourSelect.appendChild(opt);
}
```

**Load current settings values** after rendering:
```javascript
// Load fetch settings
const settings = await storage.getSettings();
hourSelect.value = settings.fetchHour;
container.querySelector('#fetch-minute').value = settings.fetchMinute;
container.querySelector('#search-keywords').value = (settings.searchKeywords || []).join(', ');
container.querySelector('#search-location').value = settings.location || '';
container.querySelector('#search-salary-min').value = settings.salaryMin || '';
container.querySelector('#search-date-posted').value = settings.datePosted || 'all';
container.querySelector('#search-employment-type').value = settings.employmentType || 'FULLTIME';
container.querySelector('#search-remote-only').checked = settings.remoteOnly || false;
```

**Load fetch status** after rendering:
```javascript
await loadFetchStatus();
```

**Add event handlers** in `attachEventListeners`:

```javascript
// Fetch time change
const hourEl = container.querySelector('#fetch-hour');
const minuteEl = container.querySelector('#fetch-minute');
const updateSchedule = async () => {
  const hour = parseInt(hourEl.value, 10);
  const minute = parseInt(minuteEl.value, 10);
  try {
    const response = await chrome.runtime.sendMessage({
      type: 'UPDATE_FETCH_SCHEDULE',
      hour,
      minute
    });
    // Also save to settings
    await storage.setSettings({ fetchHour: hour, fetchMinute: minute });
    // Update next fetch display
    if (response.nextFetchTime) {
      document.getElementById('next-fetch-time').textContent =
        new Date(response.nextFetchTime).toLocaleString();
    }
  } catch (error) {
    console.error('Failed to update schedule:', error);
  }
};
hourEl.addEventListener('change', updateSchedule);
minuteEl.addEventListener('change', updateSchedule);

// Fetch Now button
const fetchNowBtn = container.querySelector('#fetch-now-btn');
fetchNowBtn.addEventListener('click', handleFetchNow);

// Save search preferences
const saveSearchBtn = container.querySelector('#save-search-btn');
saveSearchBtn.addEventListener('click', handleSaveSearchPrefs);
```

**Add handler functions:**

`async function handleFetchNow()`:
- Get button and status elements
- Disable button, change text to "Fetching..."
- Show status: "Starting fetch..."
- Send `{ type: 'TRIGGER_FETCH' }` message
- On success: show "Fetched X jobs (Adzuna: Y, JSearch: Z)" for 5 seconds
- If cap_reached: show "Daily cap reached (100 jobs). Try again tomorrow."
- On error: show error message
- Re-enable button after completion
- Refresh fetch status display

`async function handleSaveSearchPrefs()`:
- Get values from all search input fields
- Parse keywords: split by comma, trim whitespace, filter empty strings
- Parse salaryMin: parseInt or null if empty
- Save via `storage.setSettings({ searchKeywords, location, salaryMin, datePosted, employmentType, remoteOnly })`
- Show "Saved" success indicator for 2 seconds
- Follow the same showSuccess/showError pattern as existing save handlers

`async function loadFetchStatus()`:
- Send `{ type: 'GET_FETCH_STATUS' }` message
- Update `#next-fetch-time` with formatted next fetch time (toLocaleString)
- Update `#daily-cap-status` with `"${stats.jobsFetched} / 100 jobs fetched"`
- Update `#fetch-history-list` with recent history entries:
  - For each entry: `"${entry.date}: ${entry.jobsFetched} jobs (${entry.status})"`
  - If no history: "No fetches yet"
- If fetch in progress, disable Fetch Now button, show "Fetching (stage: X)..."

**CSS additions** in `src/popup.css`:
Add styles for the new settings elements:
```css
.time-picker { display: flex; align-items: center; gap: 4px; }
.settings-select { background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; padding: 6px 8px; font-size: 13px; }
.setting-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
.setting-label { color: #999; font-size: 13px; }
.setting-value { color: #e0e0e0; font-size: 13px; }
.input-hint { color: #666; font-size: 11px; }
.checkbox-row { flex-direction: row; align-items: center; gap: 8px; }
.history-list { font-size: 12px; color: #888; margin-top: 4px; }
.history-list div { padding: 2px 0; }
.btn-sm { padding: 6px 12px; font-size: 13px; }
```

Only add these CSS rules if they don't already exist in popup.css (read it first). Don't duplicate existing styles like `.settings-input` or `.btn-primary` which are already defined.
  </action>
  <verify>
Read src/settings.js and src/popup.css and confirm:
1. Job Fetching section exists with time picker (hour + minute selects), next fetch display, daily cap status, fetch history, and Fetch Jobs Now button
2. Search Preferences section exists with keywords, location, salary, date posted, employment type, remote checkbox
3. Hour select is populated with 12 AM through 11 PM options
4. Current settings are loaded on initialization
5. Fetch time changes send UPDATE_FETCH_SCHEDULE message
6. Fetch Now button sends TRIGGER_FETCH message, shows progress, handles cap_reached
7. Save Search Preferences saves via storage.setSettings
8. loadFetchStatus displays next fetch time, daily cap, recent history
9. New CSS styles added for time picker, setting rows, history list
10. Existing settings sections (Resume, API Keys) unchanged
  </verify>
  <done>Settings panel has fetch scheduling controls (time picker), search preferences form (keywords, location, salary, filters), manual fetch button with progress, and fetch status display</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 3 job fetching and scheduling system:
1. Adzuna and JSearch API clients that fetch and normalize jobs
2. Daily alarm scheduling with user-configurable time and timezone support
3. Adaptive distribution framework (25+25 bootstrap, allocate remaining 50 based on quality)
4. Checkpoint-based fetch pipeline that survives service worker restarts
5. Background integration with missed alarm handling and batch recovery
6. Settings UI with fetch time picker, search preferences, manual trigger, and fetch status
  </what-built>
  <how-to-verify>
1. Load the extension in Chrome (chrome://extensions, Developer mode, Load unpacked)
2. Open the popup and go to Settings
3. Verify new sections appear: "Job Fetching" (with time picker, next fetch display, Fetch Now button), "Search Preferences" (with keywords, location, salary fields)
4. Set some search preferences (e.g., keywords: "software engineer", location: "San Francisco") and click "Save Search Preferences" -- confirm "Saved" feedback
5. Change the fetch time and confirm "Next fetch" updates
6. If you have valid Adzuna and JSearch API keys configured: click "Fetch Jobs Now" -- confirm button shows "Fetching..." then reports results
7. Check that daily cap display updates after fetch (e.g., "50 / 100 jobs fetched")
8. Check Chrome DevTools service worker console for fetch logs
9. If API keys not configured: click "Fetch Jobs Now" -- should show error about missing API keys (not crash)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Settings panel has three new sections: Job Fetching, Search Preferences (between Resume and API Keys)
2. Time picker allows selecting 12 AM - 11 PM with 15-minute intervals
3. Search preferences save to storage and are loaded on panel open
4. Fetch Now button triggers TRIGGER_FETCH message, shows progress, handles errors
5. Fetch status shows next fetch time, daily cap, recent history
6. All existing settings functionality preserved (Resume section, API Keys section)
</verification>

<success_criteria>
- User can set preferred fetch time via dropdown selectors
- User can configure search keywords, location, salary, date posted, employment type, remote
- User can click "Fetch Jobs Now" and see progress and results
- Daily cap status visible in settings
- Next scheduled fetch time displayed
- Recent fetch history shown (last 5 entries)
- Human verification confirms UI works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-job-fetching-scheduling/03-04-SUMMARY.md`
</output>
