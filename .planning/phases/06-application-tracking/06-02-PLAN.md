---
phase: 06-application-tracking
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/dashboard/job-modal.js
  - src/dashboard/job-card.js
  - src/popup.css
  - src/popup.js
autonomous: false

must_haves:
  truths:
    - "User can add free-form notes to any job in the detail modal"
    - "Notes auto-save with debounced persistence after user stops typing"
    - "Notes have 2000 character limit with live character counter"
    - "User sees application date picker when job status is Applied"
    - "Application date defaults to today and allows backdating"
    - "User can dismiss jobs from the detail modal"
    - "Status changes and notes persist in storage across popup close/reopen"
    - "Pending notes save flushes on modal close (no data loss)"
  artifacts:
    - path: "src/dashboard/job-modal.js"
      provides: "Notes textarea with auto-save, application date field, dismiss button in modal"
      contains: "handleNotesInput"
    - path: "src/popup.css"
      provides: "Styles for notes section, date field, character counter in modal"
      contains: "notes-section"
  key_links:
    - from: "src/dashboard/job-modal.js"
      to: "src/storage.js"
      via: "storage.updateJob for notes and applicationDate saves"
      pattern: "storage\\.updateJob"
    - from: "src/dashboard/job-modal.js"
      to: "src/dashboard/filters.js"
      via: "renderJobGrid after dismiss or status change"
      pattern: "renderJobGrid"
---

<objective>
Add notes editing, application date capture, and dismiss functionality to the job detail modal. Implement debounced auto-save for notes with character counter, conditional date picker for Applied status, and a dismiss button in the modal footer. Ensure pending saves flush on modal close to prevent data loss.

Purpose: This completes the application tracking feature set, giving users a full workflow for managing their job application pipeline with notes, dates, and dismiss from the detail view.

Output: Fully functional modal with notes, application date, dismiss, and human-verified UX.
</objective>

<execution_context>
@/Users/udirno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/udirno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-application-tracking/06-CONTEXT.md
@.planning/phases/06-application-tracking/06-RESEARCH.md
@.planning/phases/06-application-tracking/06-01-SUMMARY.md
@src/dashboard/job-modal.js
@src/dashboard/job-card.js
@src/dashboard/filters.js
@src/storage.js
@src/popup.css
@src/popup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notes, application date, and dismiss to job detail modal</name>
  <files>src/dashboard/job-modal.js, src/popup.css</files>
  <action>
**job-modal.js:** Import `storage` from `../storage.js` and `renderJobGrid` from `./filters.js`. Import `showUndoToast` from `./job-card.js` (export it in Plan 01 if not already exported).

**Debounce state:** Add module-level variables:
```javascript
let saveTimeout = null;
let pendingJobId = null;
let pendingNotes = null;
```

**renderModalContent(job):** After the description section, add a notes section and application date section before closing the modal body:

1. **Notes section** (always shown, for any job):
```html
<div class="notes-section">
  <h3 class="notes-section-title">Notes</h3>
  <textarea
    id="modal-notes"
    class="modal-notes-textarea"
    maxlength="2000"
    placeholder="Add notes about this job..."
    aria-describedby="notes-counter"
    data-job-id="${job.jobId}"
  >${escapeHtml(job.notes || '')}</textarea>
  <div id="notes-counter" class="char-counter" aria-live="polite">
    ${2000 - (job.notes || '').length} characters remaining
  </div>
</div>
```

2. **Application date section** (shown only when status is 'applied'):
```html
${job.status === 'applied' ? `
<div class="app-date-section">
  <label for="modal-app-date" class="app-date-label">Application Date</label>
  <input
    type="date"
    id="modal-app-date"
    class="modal-date-input"
    value="${job.applicationDate || new Date().toISOString().split('T')[0]}"
    max="${new Date().toISOString().split('T')[0]}"
    data-job-id="${job.jobId}"
  >
</div>
` : ''}
```

**After setting innerHTML,** attach event listeners on the notes textarea and date input:

**Notes textarea handler:**
- On `input` event: Update character counter text. Clear any existing `saveTimeout`. Set new `saveTimeout` for 1000ms that calls `storage.updateJob(jobId, { notes: textarea.value })`. Store `pendingJobId` and `pendingNotes` for flush-on-close.
- Pattern:
```javascript
const textarea = modalBody.querySelector('#modal-notes');
if (textarea) {
  textarea.addEventListener('input', (e) => {
    const notes = e.target.value;
    const counter = modalBody.querySelector('#notes-counter');
    if (counter) counter.textContent = `${2000 - notes.length} characters remaining`;
    if (notes.length < 100) {
      counter.classList.remove('warning');
    } else if (2000 - notes.length < 100) {
      counter.classList.add('warning');
    }
    pendingJobId = e.target.dataset.jobId;
    pendingNotes = notes;
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
      await storage.updateJob(pendingJobId, { notes: pendingNotes });
      pendingJobId = null;
      pendingNotes = null;
    }, 1000);
  });
}
```

**Date input handler:**
- On `change` event: Call `storage.updateJob(jobId, { applicationDate: e.target.value })` immediately (no debounce needed for date picks).

**Status change in modal:** Add a status dropdown in the modal meta row area (between location and date info). When status changes to 'applied', auto-set `applicationDate` to today if not already set. When status changes away from 'applied', hide the date section. Use `storage.updateJob(jobId, { status: newStatus })` and re-render the modal content to show/hide the date field. Also call `renderJobGrid()` to update the card in the background (the card status dropdown should reflect the change).

Actually, the status dropdown already exists on cards. For the modal, add a status dropdown in the modal-meta-row:
```html
<select class="modal-status-dropdown" data-job-id="${job.jobId}" aria-label="Job status">
  <option value="new" ${job.status === 'new' ? 'selected' : ''}>New</option>
  <option value="contacted" ${job.status === 'contacted' ? 'selected' : ''}>Contacted</option>
  <option value="applied" ${job.status === 'applied' ? 'selected' : ''}>Applied</option>
  <option value="passed" ${job.status === 'passed' ? 'selected' : ''}>Passed</option>
</select>
```

Add change handler: On status change, call `storage.updateJob(jobId, { status: newStatus })`. If newStatus is 'applied' and job has no applicationDate, also set `applicationDate: new Date().toISOString().split('T')[0]`. Update `currentJobs[currentIndex]` with the changes and re-render modal content to show/hide date field.

**Dismiss from modal:** Add a dismiss button in the modal footer, between the nav buttons. When clicked:
1. Call `storage.updateJob(jobId, { dismissed: true })`.
2. Close the modal with `modal.close()`.
3. Call `renderJobGrid()` to remove from view.
4. Call `showUndoToast('Job hidden', async () => { await storage.updateJob(jobId, { dismissed: false }); await renderJobGrid(); })`.

**Flush on close:** Update the existing `modal.addEventListener('close', ...)` handler to flush pending notes:
```javascript
modal.addEventListener('close', async () => {
  // Flush pending notes save
  if (saveTimeout) {
    clearTimeout(saveTimeout);
    saveTimeout = null;
  }
  if (pendingJobId && pendingNotes !== null) {
    await storage.updateJob(pendingJobId, { notes: pendingNotes });
    pendingJobId = null;
    pendingNotes = null;
  }
  currentJobs = [];
  currentIndex = 0;
});
```

**popup.css:** Add modal-specific styles:

```css
/* Notes section in modal */
.notes-section {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid var(--bg-secondary);
}
.notes-section-title {
  font-size: 14px;
  font-weight: 600;
  margin: 0 0 8px;
}
.modal-notes-textarea {
  width: 100%;
  min-height: 80px;
  max-height: 160px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  line-height: 1.5;
  resize: vertical;
  transition: border-color 0.2s;
}
.modal-notes-textarea:focus {
  border-color: var(--accent);
  outline: none;
}
.modal-notes-textarea::placeholder {
  color: var(--text-secondary);
}

/* Character counter */
.char-counter {
  font-size: 11px;
  color: var(--text-secondary);
  text-align: right;
  margin-top: 4px;
}
.char-counter.warning {
  color: var(--error);
}

/* Application date section */
.app-date-section {
  margin-top: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.app-date-label {
  font-size: 13px;
  color: var(--text-secondary);
  white-space: nowrap;
}
.modal-date-input {
  background: var(--bg-secondary);
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: var(--text-primary);
  padding: 6px 10px;
  font-size: 13px;
  font-family: inherit;
  color-scheme: dark;
}
.modal-date-input:focus {
  border-color: var(--accent);
  outline: none;
}

/* Modal status dropdown */
.modal-status-dropdown {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
}
.modal-status-dropdown:focus {
  border-color: var(--accent);
  outline: none;
}

/* Dismiss button in modal footer */
.btn-modal-dismiss {
  background: none;
  border: 1px solid var(--error);
  color: var(--error);
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-modal-dismiss:hover {
  background: var(--error);
  color: white;
}
```
  </action>
  <verify>
Load extension in Chrome. Open a job detail modal. Verify:
1. Notes textarea appears below the description section with "Add notes about this job..." placeholder.
2. Typing in notes shows live character counter ("1990 characters remaining").
3. After stopping typing for 1 second, notes are saved (check chrome.storage.local via DevTools).
4. Closing modal and reopening shows previously saved notes.
5. When status is changed to "Applied" via modal dropdown, a date picker appears defaulting to today.
6. Date picker allows selecting past dates but not future dates.
7. Changing date persists immediately to storage.
8. Modal footer has a dismiss button that closes the modal, hides the job from dashboard, and shows undo toast.
9. Status dropdown in modal is functional and syncs with the card status.
10. Closing modal immediately after typing notes (before debounce fires) still saves the notes (flush-on-close).
11. **Status-to-date transitions:** Open modal for a job with status "New". Change status from New to Applied via modal dropdown. Verify date picker section appears and applicationDate is auto-set to today's date.
12. **Date hides on status change away:** With the job still on Applied (date picker visible), change status from Applied back to New. Verify the date picker section disappears from the modal.
13. **Existing date preserved:** Set a job to Applied and change the date to a past date (e.g., 2026-01-15). Close and reopen the modal. Change status to New, then back to Applied. Verify the date picker reappears showing the previously saved date (2026-01-15), NOT today's date -- the existing applicationDate must be preserved, not overwritten.
  </verify>
  <done>
Notes textarea with 2000-char limit and auto-save debounce works in modal. Application date picker appears for Applied status with correct show/hide transitions on status change. Date auto-defaults to today only when no prior applicationDate exists; existing dates are preserved on re-selection of Applied. Dismiss from modal works with undo toast. Pending saves flush on modal close.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete application tracking features: dismiss with undo toast (card + modal), notes with auto-save and character counter, application date picker for Applied status, hidden jobs filter toggle, Passed status auto-hide, and note indicator on cards.</what-built>
  <how-to-verify>
1. **Dismiss from card:** Click the X button on any job card. Verify toast appears "Job hidden" with Undo button. Click Undo and verify job reappears.
2. **Dismiss from modal:** Open a job detail modal, click the dismiss button in the footer. Verify modal closes, job disappears from grid, toast shows with undo.
3. **Show hidden toggle:** Check the "Show hidden" checkbox in the toolbar. Verify dismissed jobs reappear in the grid. Uncheck to hide them again.
4. **Passed auto-hide:** Change a job's status to "Passed" via dropdown. Verify it disappears from the default "All Jobs" view. Select "Passed" from the filter dropdown to see it. Or check "Show hidden" to see it.
5. **Notes:** Open a job modal, type notes in the textarea. Verify character counter decrements. Close modal, reopen same job. Verify notes persisted.
6. **Notes edge case:** Type in notes, immediately close modal (within 1 second). Reopen. Verify notes were saved (flush-on-close).
7. **Application date:** Change a job status to "Applied" in the modal. Verify date picker appears with today's date. Select a past date. Close and reopen. Verify date persisted.
8. **Note indicator:** After adding notes to a job, close the modal. Verify a pencil icon appears on that job's card in the grid.
9. **Status sync:** Change status in modal dropdown. Close modal. Verify the card's status dropdown reflects the change.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Notes auto-save with 1-second debounce and flush on modal close.
2. 2000 character limit enforced with live counter and warning at <100 remaining.
3. Application date picker shown conditionally for Applied status, defaults to today.
4. Dismiss works from both card and modal with undo toast.
5. Passed-status jobs auto-hidden from default view.
6. "Show hidden" toggle reveals dismissed and passed jobs.
7. Note indicator on cards with notes.
8. All data persists across popup close/reopen.
</verification>

<success_criteria>
- TRACK-01 through TRACK-04: Status transitions work in any direction from card and modal
- TRACK-05: Application date captured via date picker when marking Applied
- TRACK-06: Free-form notes with 2000 char limit, auto-save, persist across sessions
- TRACK-09: Dismiss/hide with undo toast, "Show hidden" toggle for recovery
- All tracking data persists in chrome.storage.local
- Human verification confirms UX is smooth and data reliable
</success_criteria>

<output>
After completion, create `.planning/phases/06-application-tracking/06-02-SUMMARY.md`
</output>
