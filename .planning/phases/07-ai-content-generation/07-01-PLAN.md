---
phase: 07-ai-content-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content-generator.js
  - src/background.js
  - manifest.json
autonomous: true

must_haves:
  truths:
    - "Content generator produces a 3-4 paragraph cover letter given a job, resume, and optional custom instructions"
    - "Content generator produces a recruiter message under 100 words given a job, resume, and optional custom instructions"
    - "Generated content avoids AI cliches and sounds natural and conversational"
    - "Background message handler routes GENERATE_CONTENT requests from popup to content generator"
    - "Generated content is saved to job record in storage with metadata (generatedAt, isEdited)"
  artifacts:
    - path: "src/content-generator.js"
      provides: "Content generation orchestrator with prompt engineering"
      exports: ["generateContent"]
    - path: "src/background.js"
      provides: "GENERATE_CONTENT message handler"
      contains: "GENERATE_CONTENT"
    - path: "manifest.json"
      provides: "clipboardWrite permission"
      contains: "clipboardWrite"
  key_links:
    - from: "src/content-generator.js"
      to: "https://api.anthropic.com/v1/messages"
      via: "fetch with retryWithBackoff"
      pattern: "api\\.anthropic\\.com"
    - from: "src/background.js"
      to: "src/content-generator.js"
      via: "import and message handler"
      pattern: "generateContent"
    - from: "src/content-generator.js"
      to: "src/storage.js"
      via: "storage.updateJob for saving generated content"
      pattern: "storage\\.updateJob"
---

<objective>
Create the content generation engine that produces personalized cover letters and recruiter messages using Claude API, wire it into the background service worker as a message handler, and add clipboardWrite permission to manifest.

Purpose: This is the foundation for Phase 7 -- the generation logic, prompt engineering, and message routing must exist before the UI can trigger and display generated content.
Output: New content-generator.js module, updated background.js with GENERATE_CONTENT handler, updated manifest.json with clipboardWrite permission.
</objective>

<execution_context>
@/Users/udirno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/udirno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ai-content-generation/07-CONTEXT.md
@.planning/phases/07-ai-content-generation/07-RESEARCH.md

@src/api/claude-client.js
@src/background.js
@src/storage.js
@src/errors.js
@src/keep-alive.js
@manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content-generator.js module with prompt engineering</name>
  <files>src/content-generator.js</files>
  <action>
Create `src/content-generator.js` as a new module that orchestrates AI content generation. Follow these exact patterns:

**Imports:** Import `retryWithBackoff` and `createApiError` from `./errors.js`, and `storage` from `./storage.js`. Do NOT import from `./api/claude-client.js` -- this module makes its own Claude API calls (different prompt structure than scoring).

**Main export: `generateContent(contentType, job, apiKey, customInstructions)`**
- `contentType`: 'coverLetter' or 'recruiterMessage'
- `job`: Job object from storage (has title, company, location, description, salary)
- `apiKey`: Claude API key string
- `customInstructions`: Optional string for user-provided generation guidance (e.g., "emphasize leadership", "mention relocation")
- Returns: `{ content: string, usage: object }` on success, throws on failure

**Implementation details:**

1. Load resume from storage: `const resume = await storage.getResume()` -- if no resume, throw Error('No resume uploaded. Please upload your resume in Settings first.')

2. Build request body for Claude API:
   - `model`: 'claude-haiku-4-5' (per research: cost-effective at $1/$5 per MTok)
   - `max_tokens`: 800 for coverLetter, 200 for recruiterMessage
   - `system`: Array of two objects with `cache_control: { type: 'ephemeral' }` each:
     - First: System prompt from `buildSystemPrompt(contentType)` (see below)
     - Second: `Candidate Resume:\n\n${resume.text}`
   - `messages`: Single user message from `buildUserPrompt(contentType, job, customInstructions)` (see below)
   - Do NOT use `output_config` / structured outputs -- we want free-form text, not JSON

3. Make API call using `retryWithBackoff` wrapping `fetch('https://api.anthropic.com/v1/messages', ...)` with headers:
   - `'x-api-key': apiKey`
   - `'anthropic-version': '2023-06-01'`
   - `'content-type': 'application/json'`
   - Handle non-ok response with `createApiError(response, 'claude')`

4. Extract text from `result.content[0].text`, log usage stats (input_tokens, cache_creation_input_tokens, cache_read_input_tokens, output_tokens)

5. Save generated content to job record using `storage.updateJob(job.jobId, { generated })`:
   - Build the `generated` object: merge with existing `job.generated || {}`
   - Set `generated[contentType] = { content, generatedAt: new Date().toISOString(), editedAt: null, isEdited: false }`
   - This tracks metadata per user decision (generation timestamp + AI-generated vs user-edited distinction)

6. Return `{ content, usage: result.usage }`

**buildSystemPrompt(contentType):**
Role-based system prompt with explicit negative constraints. Per user locked decision: professional but conversational tone, avoid AI cliches.

```
You are an expert career advisor. Write a ${contentType === 'coverLetter' ? 'cover letter (3-4 paragraphs)' : 'short recruiter message (under 100 words)'} that sounds like a real person wrote it.

TONE: Professional but conversational. Approachable and natural, not stiff or robotic. Write like you're emailing a colleague, not writing a formal letter.

${contentType === 'coverLetter'
  ? 'STRUCTURE:\n- Opening: Connect your experience to their specific needs (1-2 sentences)\n- Body: 2-3 concrete examples of relevant work with numbers when possible (2 paragraphs)\n- Close: Clear next step, keep it casual (1-2 sentences)\n- Total: 3-4 paragraphs'
  : 'STRUCTURE:\n- Hook: Why you are reaching out about this specific role (1 sentence)\n- Relevance: 1-2 specific points connecting your background to the role\n- Ask: Simple, low-pressure call to action\n- Total: Under 100 words'}

CRITICAL RULES:
1. Reference specific skills and experiences from the resume that match the job
2. Use concrete examples with numbers and specifics when possible
3. Keep sentences varied in length (mix short and long)
4. Start with a relevant insight or connection, NOT a generic opener

NEVER use these phrases (they sound robotic and AI-generated):
- "I am writing to express my interest"
- "I am excited to apply"
- "Leverage my skills"
- "Proven track record"
- "Results-driven"
- "Think outside the box"
- "Hit the ground running"
- "I would love the opportunity"
- "I am confident that"
- "Passionate about"
- "Dynamic team"
- "Fast-paced environment"
- "Strong communication skills"

Write ONLY the ${contentType === 'coverLetter' ? 'cover letter' : 'message'} text. No subject line, no greeting like "Dear Hiring Manager" for recruiter messages. For cover letters, include a natural greeting and sign-off.
```

**buildUserPrompt(contentType, job, customInstructions):**
```
Write a ${contentType === 'coverLetter' ? 'cover letter' : 'recruiter message'} for this position:

Job Title: ${job.title}
Company: ${job.company}
${job.location ? `Location: ${job.location}` : ''}

Job Description:
${extractKeyRequirements(job.description)}

${customInstructions ? `\nAdditional instructions: ${customInstructions}` : ''}
```

**extractKeyRequirements(description):**
- Try regex to find requirements/qualifications/responsibilities sections (similar to `extractJobCore` in claude-client.js)
- If structured sections found, join and cap at 1000 chars
- If no sections found, take first 1000 chars of description
- This keeps token costs down while giving Claude enough context
  </action>
  <verify>
File exists at `src/content-generator.js`. Grep for: `generateContent`, `buildSystemPrompt`, `buildUserPrompt`, `extractKeyRequirements`, `cache_control`, `claude-haiku-4-5`, `NEVER use these phrases`, `storage.updateJob`, `isEdited`. All must be present.
  </verify>
  <done>
content-generator.js module exists with generateContent export that calls Claude API with prompt-cached system prompt + resume, uses Haiku 4.5, includes anti-cliche constraints, saves generated content with metadata to storage, and handles both coverLetter and recruiterMessage content types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire background message handler and add manifest permission</name>
  <files>src/background.js, manifest.json</files>
  <action>
**manifest.json:** Add `"clipboardWrite"` to the `permissions` array. This is required for `navigator.clipboard.writeText()` in the popup context per Chrome extension docs. Place it after `"alarms"`.

**src/background.js:**

1. Add import at the top (after existing imports):
   `import { generateContent } from './content-generator.js';`

2. Add a new case in the `handleMessage` switch statement, before the `default` case:

```javascript
case 'GENERATE_CONTENT': {
  const { contentType, jobId, customInstructions } = message;
  console.log(`Content generation requested: ${contentType} for job ${jobId}`);
  try {
    // Get job from storage
    const jobs = await storage.getJobs();
    const job = jobs[jobId];
    if (!job) {
      return { success: false, error: 'Job not found' };
    }

    // Get Claude API key
    const apiKeys = await storage.getApiKeys();
    if (!apiKeys.claude) {
      return { success: false, error: 'Claude API key not configured. Please add it in Settings.' };
    }

    // Run generation with keep-alive (prevents service worker termination)
    const result = await keepAlive.withKeepAlive('content-gen', async () => {
      return await generateContent(contentType, job, apiKeys.claude, customInstructions || '');
    });

    return { success: true, content: result.content, usage: result.usage };
  } catch (error) {
    console.error('Content generation failed:', error);
    return { success: false, error: error.message };
  }
}
```

Key design choices:
- Uses `keepAlive.withKeepAlive('content-gen', ...)` to prevent service worker termination during 2-5 second API call (same pattern as SCORE_JOBS handler)
- Returns `{ success, content, usage }` or `{ success: false, error }` for consistent error handling
- Validates job exists and API key is configured before attempting generation
- The `content-gen` keep-alive tag is distinct from `ai-scoring` and `job-fetch` tags
  </action>
  <verify>
1. `manifest.json` contains `"clipboardWrite"` in permissions array
2. `src/background.js` imports `generateContent` from `./content-generator.js`
3. `src/background.js` contains `case 'GENERATE_CONTENT'` in the switch statement
4. `src/background.js` contains `keepAlive.withKeepAlive('content-gen'`
  </verify>
  <done>
Background service worker handles GENERATE_CONTENT messages by loading job from storage, validating API key, running content generation with keep-alive protection, and returning result to popup. Manifest includes clipboardWrite permission for copy-to-clipboard functionality.
  </done>
</task>

</tasks>

<verification>
1. `src/content-generator.js` exists with `generateContent` export
2. `manifest.json` includes `clipboardWrite` permission
3. `src/background.js` imports and uses `generateContent` in message handler
4. System prompt includes anti-cliche constraints and professional-but-conversational tone guidance
5. Content is saved to storage with metadata (generatedAt, isEdited, editedAt)
6. Both coverLetter and recruiterMessage content types are supported with different max_tokens and structure guidance
</verification>

<success_criteria>
- Content generation module created with Claude API integration reusing existing error handling and retry patterns
- Background handler routes GENERATE_CONTENT messages from popup with keep-alive protection
- Prompt engineering includes negative examples (banned phrases) and explicit tone/structure requirements per user decisions
- Generated content automatically saved to job record with tracking metadata
- clipboardWrite permission added to manifest for Plan 02's copy functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-content-generation/07-01-SUMMARY.md`
</output>
