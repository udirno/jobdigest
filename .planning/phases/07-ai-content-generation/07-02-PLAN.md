---
phase: 07-ai-content-generation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/dashboard/job-modal.js
  - src/popup.css
  - src/popup.html
autonomous: false

must_haves:
  truths:
    - "User can click a button in job detail modal to generate a cover letter"
    - "User can click a button in job detail modal to generate a recruiter message"
    - "User sees loading feedback while content generates"
    - "Generated content displays in editable textarea within the modal"
    - "User can edit generated content and changes auto-save"
    - "User can copy generated content to clipboard with visual feedback"
    - "User can regenerate content (with confirmation if edited)"
    - "User can provide custom instructions before generating"
    - "Previously generated content loads when reopening modal for same job"
  artifacts:
    - path: "src/dashboard/job-modal.js"
      provides: "Content generation UI in modal with generate buttons, display, editing, copy"
      contains: "GENERATE_CONTENT"
    - path: "src/popup.css"
      provides: "Styles for content generation section, textareas, buttons, loading states"
      contains: "content-gen"
    - path: "src/popup.html"
      provides: "No structural changes needed (modal body is dynamic)"
  key_links:
    - from: "src/dashboard/job-modal.js"
      to: "src/background.js"
      via: "chrome.runtime.sendMessage GENERATE_CONTENT"
      pattern: "sendMessage.*GENERATE_CONTENT"
    - from: "src/dashboard/job-modal.js"
      to: "src/storage.js"
      via: "storage.updateJob for saving edited content"
      pattern: "storage\\.updateJob"
    - from: "src/dashboard/job-modal.js"
      to: "navigator.clipboard"
      via: "navigator.clipboard.writeText for copy"
      pattern: "navigator\\.clipboard\\.writeText"
---

<objective>
Add content generation UI to the job detail modal -- generate buttons, loading states, content display with editable textareas, copy-to-clipboard, custom instructions field, and regeneration with edit protection.

Purpose: This is the user-facing half of Phase 7. Users interact with generated content entirely through the modal, which triggers generation, displays results, supports editing, and enables copying.
Output: Updated job-modal.js with content generation section, updated popup.css with generation styles.
</objective>

<execution_context>
@/Users/udirno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/udirno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ai-content-generation/07-CONTEXT.md
@.planning/phases/07-ai-content-generation/07-RESEARCH.md
@.planning/phases/07-ai-content-generation/07-01-SUMMARY.md

@src/dashboard/job-modal.js
@src/popup.css
@src/popup.html
@src/storage.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add content generation UI to job modal</name>
  <files>src/dashboard/job-modal.js, src/popup.css</files>
  <action>
**In src/dashboard/job-modal.js:**

Add a content generation section to the `renderModalContent(job)` function. Insert it AFTER the description section and BEFORE the notes section. This section handles both generation triggers and content display/editing.

**Content generation section layout (discretion choices documented):**

Using **expandable sections** (one for cover letter, one for recruiter message) because:
- Both content types visible at a glance without tabs
- Collapsed by default to not overwhelm the modal
- Each section self-contained with its own generate/edit/copy controls

Using **separate buttons** for cover letter and recruiter message (not a combined dropdown) because:
- Clearer affordance -- user knows exactly what each button does
- Simpler interaction (one click, not two)

Using **per-job custom instructions** in the modal (not global settings) because:
- Simpler UX, no new settings panel section needed
- Different jobs may need different emphasis (leadership vs technical vs relocation)
- Single text input above the generate buttons

**HTML structure to inject in renderModalContent:**

```html
<div class="content-gen-section">
  <h3 class="content-gen-title">AI Content</h3>

  <!-- Custom instructions input (shared across both content types) -->
  <div class="custom-instructions">
    <input type="text"
      id="custom-instructions"
      class="custom-instructions-input"
      placeholder="Custom instructions (e.g., emphasize leadership, mention relocation)"
      maxlength="200"
      data-job-id="${job.jobId}" />
  </div>

  <!-- Cover Letter Section -->
  <div class="content-block" id="cover-letter-block">
    <div class="content-block-header" data-toggle="cover-letter-body">
      <span class="content-block-label">Cover Letter</span>
      <span class="content-block-status" id="cl-status">${job.generated?.coverLetter ? (job.generated.coverLetter.isEdited ? 'Edited' : 'Generated') : ''}</span>
      <span class="content-block-chevron">&#9660;</span>
    </div>
    <div class="content-block-body" id="cover-letter-body" style="display: ${job.generated?.coverLetter ? 'block' : 'none'};">
      ${job.generated?.coverLetter ? renderContentArea('coverLetter', job) : renderGenerateButton('coverLetter', job.jobId)}
    </div>
  </div>

  <!-- Recruiter Message Section -->
  <div class="content-block" id="recruiter-msg-block">
    <div class="content-block-header" data-toggle="recruiter-msg-body">
      <span class="content-block-label">Recruiter Message</span>
      <span class="content-block-status" id="rm-status">${job.generated?.recruiterMessage ? (job.generated.recruiterMessage.isEdited ? 'Edited' : 'Generated') : ''}</span>
      <span class="content-block-chevron">&#9660;</span>
    </div>
    <div class="content-block-body" id="recruiter-msg-body" style="display: ${job.generated?.recruiterMessage ? 'block' : 'none'};">
      ${job.generated?.recruiterMessage ? renderContentArea('recruiterMessage', job) : renderGenerateButton('recruiterMessage', job.jobId)}
    </div>
  </div>
</div>
```

**Helper functions to add:**

`renderGenerateButton(contentType, jobId)` -- Returns HTML for a generate button:
```html
<button class="btn-generate" data-content-type="${contentType}" data-job-id="${jobId}">
  Generate ${contentType === 'coverLetter' ? 'Cover Letter' : 'Recruiter Message'}
</button>
```

`renderContentArea(contentType, job)` -- Returns HTML for displaying generated content with edit/copy/regenerate:
```html
<textarea class="content-textarea" data-content-type="${contentType}" data-job-id="${job.jobId}">${escapeHtml(job.generated[contentType].content)}</textarea>
<div class="content-actions">
  <button class="btn-copy" data-content-type="${contentType}">Copy</button>
  <button class="btn-regenerate" data-content-type="${contentType}" data-job-id="${job.jobId}">Regenerate</button>
  <span class="content-meta">${formatContentMeta(job.generated[contentType])}</span>
</div>
```

`formatContentMeta(contentObj)` -- Returns metadata string:
- If `isEdited`: "Edited ${relative time of editedAt}"
- Else: "Generated ${relative time of generatedAt}"
- Use simple relative time (e.g., "just now", "5 min ago", "today", "yesterday")

**Event handlers to attach after `modalBody.innerHTML = html` (within renderModalContent):**

1. **Toggle expand/collapse** for content block headers:
   - Click on `.content-block-header` toggles display of corresponding body
   - Toggle chevron rotation (down = collapsed, up = expanded)

2. **Generate button click** (`.btn-generate`):
   - Disable button, change text to "Generating...", add loading class
   - Get custom instructions from `#custom-instructions` input
   - Send `chrome.runtime.sendMessage({ type: 'GENERATE_CONTENT', contentType, jobId, customInstructions })`
   - On success: Update `currentJobs[currentIndex]` with new generated data, re-render modal content, auto-expand the section
   - On error: Show error in a small inline message below the button, re-enable button
   - Re-call `updateNavigation()` after re-render

3. **Content textarea input** (`.content-textarea`):
   - Debounced auto-save (reuse the same pattern as notes: 1-second timeout with flush-on-close)
   - On save: Use `storage.updateJob(jobId, { generated: { ...existing, [contentType]: { ...existing[contentType], content: newContent, editedAt: new Date().toISOString(), isEdited: true } } })`
   - Auto-resize textarea height on input (set `textarea.style.height = 'auto'` then `textarea.style.height = textarea.scrollHeight + 'px'`)
   - Update `currentJobs[currentIndex]` in memory too

4. **Copy button click** (`.btn-copy`):
   - Get content from the sibling textarea
   - Call `navigator.clipboard.writeText(content)`
   - On success: Change button text to "Copied!" for 2 seconds, then revert
   - On error: Change button text to "Copy failed" for 2 seconds

5. **Regenerate button click** (`.btn-regenerate`):
   - Check if content `isEdited` on the current job object
   - If edited: Show `confirm('You have edited this content. Regenerate anyway?')` -- if user cancels, return
   - If not edited or user confirmed: Follow same flow as generate button (disable, "Generating...", send message, update on success)

**Debounce state for content auto-save:**
Add module-level variables alongside existing notes debounce:
```javascript
let contentSaveTimeout = null;
let pendingContentJobId = null;
let pendingContentUpdate = null;
```

Update the modal `close` event handler to also flush pending content saves (same pattern as notes flush-on-close).

**Auto-resize textareas:** After rendering content textareas, call auto-resize on each to fit initial content. Also bind input event for ongoing resize.

**In src/popup.css:**

Add styles for the content generation section. Use existing design system variables (--bg-primary, --bg-secondary, --accent, --text-primary, --text-secondary). Key styles:

```css
/* Content generation section */
.content-gen-section { margin-top: 16px; }
.content-gen-title { font-size: 14px; color: var(--accent); margin-bottom: 8px; font-weight: 600; }

/* Custom instructions */
.custom-instructions { margin-bottom: 12px; }
.custom-instructions-input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-primary);
  border: 1px solid #444;
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 13px;
  outline: none;
}
.custom-instructions-input:focus { border-color: var(--accent); }
.custom-instructions-input::placeholder { color: var(--text-secondary); }

/* Content blocks (expandable) */
.content-block {
  background: var(--bg-primary);
  border: 1px solid #333;
  border-radius: 8px;
  margin-bottom: 8px;
  overflow: hidden;
}
.content-block-header {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  cursor: pointer;
  user-select: none;
}
.content-block-header:hover { background: rgba(255,255,255,0.03); }
.content-block-label { font-weight: 500; font-size: 13px; flex: 1; }
.content-block-status {
  font-size: 11px;
  color: var(--text-secondary);
  margin-right: 8px;
}
.content-block-chevron {
  font-size: 10px;
  color: var(--text-secondary);
  transition: transform 0.2s;
}
.content-block-header.expanded .content-block-chevron { transform: rotate(180deg); }

.content-block-body { padding: 0 14px 14px; }

/* Generate button */
.btn-generate {
  width: 100%;
  padding: 10px;
  background: var(--accent);
  color: var(--bg-primary);
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.2s;
}
.btn-generate:hover { opacity: 0.9; }
.btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-generate.loading { background: var(--bg-secondary); color: var(--text-secondary); }

/* Content textarea */
.content-textarea {
  width: 100%;
  min-height: 120px;
  padding: 10px;
  background: var(--bg-secondary);
  border: 1px solid #444;
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 13px;
  line-height: 1.6;
  resize: none;
  overflow: hidden;
  font-family: inherit;
}
.content-textarea:focus { border-color: var(--accent); outline: none; }

/* Content actions row */
.content-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}
.btn-copy, .btn-regenerate {
  padding: 6px 14px;
  font-size: 12px;
  border-radius: 4px;
  border: 1px solid #555;
  background: transparent;
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.2s;
}
.btn-copy:hover, .btn-regenerate:hover { border-color: var(--accent); color: var(--accent); }
.btn-copy.success { border-color: var(--success); color: var(--success); }
.btn-copy.error { border-color: var(--error); color: var(--error); }
.content-meta {
  font-size: 11px;
  color: var(--text-secondary);
  margin-left: auto;
}

/* Inline error message */
.gen-error {
  color: var(--error);
  font-size: 12px;
  margin-top: 6px;
}
```
  </action>
  <verify>
1. Open the extension popup, click a job card to open modal
2. Verify "AI Content" section appears below job description, above notes
3. Both "Cover Letter" and "Recruiter Message" expandable sections visible
4. Custom instructions input field is present
5. Click expand on a content section -- generate button appears
6. Click generate -- button shows "Generating..." loading state
7. After generation completes, textarea appears with content, plus Copy and Regenerate buttons
8. Edit the content -- verify auto-save (check storage after a few seconds)
9. Click Copy -- verify "Copied!" feedback and content is in clipboard
10. Click Regenerate on edited content -- confirm dialog appears
11. Close modal and reopen same job -- previously generated content is displayed
  </verify>
  <done>
Content generation UI is fully integrated into job detail modal with: expandable sections for cover letter and recruiter message, custom instructions input, generate/regenerate buttons with loading states, editable textareas with debounced auto-save, copy-to-clipboard with visual feedback, edit detection with regeneration confirmation, and persistence of generated content across modal opens.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete AI content generation feature: cover letter and recruiter message generation from job detail modal, with inline editing, copy-to-clipboard, custom instructions, and regeneration support</what-built>
  <how-to-verify>
1. Open extension popup and click on any scored job card to open the detail modal
2. Scroll down past the job description -- verify "AI Content" section is visible with "Cover Letter" and "Recruiter Message" expandable blocks
3. Expand "Cover Letter" block -- verify generate button appears
4. Type "emphasize backend experience" in custom instructions field
5. Click "Generate Cover Letter" -- verify loading state appears (button disabled, "Generating..." text)
6. After 2-5 seconds, verify a 3-4 paragraph cover letter appears in an editable textarea
7. Verify the content references your resume skills AND the job description
8. Verify the content does NOT contain AI cliches like "I am writing to express my interest" or "leverage my skills"
9. Verify Copy and Regenerate buttons appear below the textarea
10. Click "Copy" -- verify button briefly shows "Copied!" and content is in your clipboard (paste somewhere to confirm)
11. Edit the generated text (change a word) -- wait 2 seconds, close and reopen modal -- verify edit persisted
12. Click "Regenerate" -- verify confirmation dialog appears (since you edited)
13. Expand "Recruiter Message" block and generate -- verify message is under 100 words and conversational
14. Close modal and reopen same job -- verify both generated contents are still displayed
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the generated content quality, UI layout, or functionality</resume-signal>
</task>

</tasks>

<verification>
1. Content generation buttons appear in job detail modal for both cover letter and recruiter message
2. Generate sends GENERATE_CONTENT message to background, receives content back
3. Loading state shown during generation (2-5 seconds)
4. Generated content displays in editable textarea with auto-resize
5. Copy-to-clipboard works with navigator.clipboard.writeText() and visual feedback
6. Editing auto-saves with 1-second debounce and flush-on-close
7. Regenerate warns if content was edited
8. Custom instructions field passes text to generation prompt
9. Previously generated content persists and loads on modal reopen
10. Cover letters are 3-4 paragraphs, recruiter messages under 100 words
11. Content reads naturally without AI cliches
</verification>

<success_criteria>
- User can generate cover letter (3-4 paragraphs) tailored to specific job and resume [CONTENT-01]
- User can generate recruiter message (under 100 words) tailored to specific job [CONTENT-02]
- Generated cover letters reference both resume skills and job description requirements [CONTENT-03]
- Generated recruiter messages reference both resume experience and job description [CONTENT-04]
- Extension stores generated cover letters with job for reference [TRACK-07]
- Extension stores generated recruiter messages with job for reference [TRACK-08]
- All 6 requirements (CONTENT-01 through CONTENT-04, TRACK-07, TRACK-08) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-content-generation/07-02-SUMMARY.md`
</output>
