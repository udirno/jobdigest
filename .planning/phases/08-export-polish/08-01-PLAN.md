---
phase: 08-export-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - manifest.json
  - src/csv-exporter.js
  - src/popup.html
  - src/popup.js
  - src/popup.css
autonomous: true

must_haves:
  truths:
    - "User can click Export button in dashboard toolbar and receive a CSV file download"
    - "CSV file contains job metadata columns: jobId, title, company, location, score, status, applicationDate, notes"
    - "CSV file contains generated content columns: coverLetter, recruiterMessage with edit metadata"
    - "CSV handles special characters correctly (commas, quotes, newlines in notes and cover letters)"
    - "CSV opens correctly in Excel with proper UTF-8 encoding"
  artifacts:
    - path: "src/csv-exporter.js"
      provides: "CSV generation with RFC 4180 escaping and Chrome downloads integration"
      exports: ["generateCSV", "downloadCSV", "exportJobs"]
      min_lines: 60
    - path: "manifest.json"
      provides: "downloads permission for chrome.downloads API"
      contains: "downloads"
    - path: "src/popup.html"
      provides: "Export button in dashboard toolbar"
      contains: "export-btn"
  key_links:
    - from: "src/csv-exporter.js"
      to: "src/storage.js"
      via: "import storage.getJobs()"
      pattern: "storage\\.getJobs"
    - from: "src/popup.js"
      to: "src/csv-exporter.js"
      via: "import exportJobs"
      pattern: "import.*csv-exporter"
    - from: "src/csv-exporter.js"
      to: "chrome.downloads.download()"
      via: "blob URL download trigger"
      pattern: "chrome\\.downloads\\.download"
---

<objective>
Create CSV export functionality that lets users download all tracked jobs as a properly formatted CSV file.

Purpose: Users need to export their job tracking data for external analysis, backup, or sharing. This is a core requirement (EXPORT-01, EXPORT-02, EXPORT-03) for the final phase.
Output: New csv-exporter.js module, Export button in dashboard toolbar, downloads permission in manifest.
</objective>

<execution_context>
@/Users/udirno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/udirno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/storage.js
@src/popup.html
@src/popup.js
@src/popup.css
@src/dashboard/filters.js
@manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV exporter module with RFC 4180 escaping and Chrome downloads integration</name>
  <files>src/csv-exporter.js, manifest.json</files>
  <action>
Create src/csv-exporter.js with the following exported functions:

1. **escapeCSVField(value)** - RFC 4180 compliant field escaping:
   - Return empty string for null/undefined
   - Sanitize CSV injection: prefix fields starting with =, +, -, @ with single quote (')
   - If field contains comma, double-quote, or newline/carriage-return, wrap in double quotes and double any internal quotes
   - Example: `"Text with ""quotes"""` for `Text with "quotes"`

2. **flattenJobForCSV(job)** - Flatten nested job object to single-level object with explicit field whitelist (NO generic flattening to prevent sensitive data leaks):
   - Core metadata: jobId, title, company, location, url, source, postedAt, fetchedAt
   - Scoring: score, scoreReasoning (from scoreReasoning field if exists)
   - Tracking: status (default 'new'), applicationDate, notes, dismissed (Yes/No)
   - Generated content: coverLetter (from generated.coverLetter.content), coverLetterGenerated (timestamp), coverLetterEdited (Yes/No), recruiterMessage (from generated.recruiterMessage.content), recruiterMessageGenerated (timestamp), recruiterMessageEdited (Yes/No)
   - Use optional chaining for nested fields with '' fallback

3. **generateCSV(jobs)** - Convert array of job objects to CSV string:
   - Throw Error('No jobs to export') if empty/null array
   - Flatten all jobs via flattenJobForCSV
   - Extract headers from first flattened job (Object.keys preserves insertion order)
   - Build header row with escapeCSVField on each header
   - Build data rows mapping each job's values through escapeCSVField
   - Join rows with CRLF (\r\n) per RFC 4180
   - Prepend UTF-8 BOM (\uFEFF) for Excel compatibility
   - Return complete CSV string

4. **downloadCSV(csvString, filename)** - Trigger file download via Chrome downloads API:
   - Create Blob with type 'text/csv;charset=utf-8;'
   - Create blob URL via URL.createObjectURL()
   - Call chrome.downloads.download() with { url: blobUrl, filename, saveAs: true }
   - Clean up blob URL via setTimeout(() => URL.revokeObjectURL(blobUrl), 1000) on success
   - On error: immediately revoke URL, then re-throw

5. **exportJobs()** - High-level export function:
   - Import storage from './storage.js'
   - Get all jobs via storage.getJobs(), convert to array with Object.values()
   - Throw Error('No jobs to export') if array is empty
   - Generate timestamped filename: `job-digest-export-YYYY-MM-DD.csv`
   - Call generateCSV then downloadCSV
   - Return download ID

In manifest.json: Add "downloads" to the permissions array (after "clipboardWrite").
  </action>
  <verify>
Verify manifest.json contains "downloads" in permissions array. Verify src/csv-exporter.js exists and exports generateCSV, downloadCSV, and exportJobs functions. Verify the file imports from storage.js. Grep for escapeCSVField to confirm RFC 4180 escaping is implemented. Grep for '\uFEFF' to confirm UTF-8 BOM. Grep for 'chrome.downloads.download' to confirm download API usage. Grep for 'revokeObjectURL' to confirm blob cleanup.
  </verify>
  <done>
csv-exporter.js module exists with all 5 functions, RFC 4180 escaping handles commas/quotes/newlines, CSV injection prevention prefixes formula characters, UTF-8 BOM prepended, blob URL cleanup after download, manifest has downloads permission.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Export button to dashboard toolbar and wire up click handler</name>
  <files>src/popup.html, src/popup.js, src/popup.css</files>
  <action>
In src/popup.html:
- Add an Export button in the toolbar-left div, after the show-hidden label:
  `<button id="export-btn" class="btn-export" title="Export all jobs to CSV">Export CSV</button>`
- Place it after the filter-toggle label so the layout is: job count | show hidden toggle | export button

In src/popup.js:
- Import { exportJobs } from './csv-exporter.js'
- In the DOMContentLoaded handler, after initializing dashboard controls, get the export button element:
  `const exportBtn = document.getElementById('export-btn');`
- Add click handler to exportBtn:
  - Set button disabled=true and textContent='Exporting...' on click
  - try: await exportJobs()
  - On success: briefly show 'Exported!' text for 1.5 seconds, then restore to 'Export CSV'
  - On error: if error.message includes 'No jobs', show toast or alert 'No jobs to export'; otherwise show 'Export failed' briefly
  - finally: re-enable button

In src/popup.css:
- Add .btn-export styling matching the existing toolbar aesthetic:
  - Background: transparent or subtle sand-brown accent
  - Border: 1px solid var(--border-color) or similar to existing toolbar-select styling
  - Color: var(--text-secondary) or the sand-brown accent color
  - Padding: 4px 12px
  - Border-radius: 4px
  - Font-size: 12px
  - Cursor: pointer
  - Hover: slightly brighter background
  - Disabled state: opacity 0.5, cursor not-allowed
  - Transition: background-color 0.2s
- Make sure the toolbar-left has appropriate gap/spacing to accommodate the new button without crowding
  </action>
  <verify>
Open the extension popup manually (load unpacked in chrome://extensions). Verify the Export CSV button appears in the toolbar. Click the button -- if there are jobs, a file picker dialog should appear to save the CSV. If no jobs exist, verify the button shows appropriate feedback. Open the downloaded CSV in a text editor to verify headers and data are present. Open in Excel/Google Sheets to verify columns parse correctly.
  </verify>
  <done>
Export CSV button visible in dashboard toolbar, clicking it triggers CSV download with file picker dialog, downloaded file has correct headers (jobId, title, company, location, url, source, postedAt, fetchedAt, score, scoreReasoning, status, applicationDate, notes, dismissed, coverLetter, coverLetterGenerated, coverLetterEdited, recruiterMessage, recruiterMessageGenerated, recruiterMessageEdited), data rows contain actual job data with proper escaping, empty state shows appropriate message.
  </done>
</task>

</tasks>

<verification>
1. Load extension in chrome://extensions (developer mode, load unpacked)
2. Verify Export CSV button appears in the toolbar next to filter controls
3. With existing jobs: click Export CSV, verify file picker appears, save file
4. Open CSV in text editor: verify UTF-8 BOM at start, CRLF line endings, proper quoting
5. Open CSV in Excel: verify columns display correctly, no garbled characters
6. If a job has notes with commas or quotes, verify those cells are properly escaped
7. If a job has generated cover letter with newlines, verify it's wrapped in quotes and contained in a single cell
8. With no jobs: click Export, verify "No jobs to export" feedback
9. Verify manifest.json has "downloads" permission
</verification>

<success_criteria>
- Export CSV button is visible and functional in dashboard toolbar
- CSV file downloads with all required columns (metadata + generated content)
- Special characters (commas, quotes, newlines) are properly escaped per RFC 4180
- CSV opens correctly in Excel with UTF-8 encoding
- Empty job list shows appropriate error feedback
- No sensitive data (API keys) appears in exported CSV
</success_criteria>

<output>
After completion, create `.planning/phases/08-export-polish/08-01-SUMMARY.md`
</output>
