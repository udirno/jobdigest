---
phase: 08-export-polish
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/storage.js
  - src/popup.js
  - src/popup.html
  - src/popup.css
autonomous: true

must_haves:
  truths:
    - "Extension checks storage usage every time popup opens"
    - "User sees persistent warning banner when storage exceeds 80% of 10MB quota"
    - "Warning banner shows percentage used and actionable guidance"
    - "Warning banner has Export Jobs and Manage Storage action buttons"
    - "Storage usage is visible in settings panel for awareness even below 80%"
  artifacts:
    - path: "src/storage.js"
      provides: "getStorageUsage() method returning bytes, percent, and warning flag"
      contains: "getStorageUsage"
    - path: "src/popup.js"
      provides: "Storage check on dashboard initialization"
      contains: "getStorageUsage"
    - path: "src/popup.html"
      provides: "Storage warning banner placeholder area"
      contains: "storage-warning"
  key_links:
    - from: "src/popup.js"
      to: "src/storage.js"
      via: "import storage.getStorageUsage()"
      pattern: "getStorageUsage"
    - from: "src/popup.js"
      to: "src/csv-exporter.js"
      via: "Export Jobs button in warning banner triggers exportJobs()"
      pattern: "exportJobs"
    - from: "src/storage.js"
      to: "chrome.storage.local.getBytesInUse()"
      via: "Chrome storage API for quota monitoring"
      pattern: "getBytesInUse"
---

<objective>
Add storage usage monitoring with warning system that alerts users when chrome.storage.local approaches capacity.

Purpose: Prevent silent data loss when storage quota is exceeded (ERROR-06). Users need proactive warnings to export/clean data before hitting limits.
Output: getStorageUsage() method in storage.js, persistent warning banner in dashboard, storage usage display in settings.
</objective>

<execution_context>
@/Users/udirno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/udirno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-export-polish/08-01-SUMMARY.md
@src/storage.js
@src/popup.html
@src/popup.js
@src/popup.css
@src/settings.js
@src/csv-exporter.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getStorageUsage() method to storage module</name>
  <files>src/storage.js</files>
  <action>
Add a new method to the storage object in src/storage.js:

**getStorageUsage()** - Returns storage usage statistics:
- Call chrome.storage.local.getBytesInUse(null) to get total bytes used across all keys
- Define QUOTA_BYTES as 10 * 1024 * 1024 (10MB - conservative estimate even with unlimitedStorage permission; better to warn early)
- Calculate percentUsed = Math.round((bytesInUse / QUOTA_BYTES) * 100)
- Return object:
  ```
  {
    bytesInUse: number,
    quotaBytes: QUOTA_BYTES,
    megabytesUsed: (bytesInUse / (1024 * 1024)).toFixed(2),
    megabytesQuota: '10.00',
    percentUsed: number (0-100+),
    shouldWarn: percentUsed >= 80,
    isCritical: percentUsed >= 95
  }
  ```
- Wrap in try/catch: on error, return a safe default { bytesInUse: 0, percentUsed: 0, shouldWarn: false, isCritical: false } with console.error logging (storage monitoring should never crash the app)

Place this method after the existing updateJob() method, before the closing of the storage object.
  </action>
  <verify>
Verify src/storage.js contains getStorageUsage method. Grep for 'getBytesInUse' to confirm Chrome API usage. Grep for 'shouldWarn' to confirm 80% threshold. Grep for 'isCritical' to confirm 95% threshold.
  </verify>
  <done>
storage.getStorageUsage() method exists, calls getBytesInUse(null), returns usage stats with shouldWarn at 80% and isCritical at 95%, has error handling that won't crash the app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add storage warning banner to dashboard and storage display in settings</name>
  <files>src/popup.html, src/popup.js, src/popup.css, src/settings.js</files>
  <action>
**src/popup.html:**
- Add a warning banner container div BEFORE the dashboard-toolbar div (inside main-view):
  ```html
  <div id="storage-warning" class="storage-warning" style="display: none;"></div>
  ```
  This is hidden by default and shown dynamically when storage exceeds 80%.

**src/popup.js:**
- Import { storage } from './storage.js' (if not already imported -- check existing imports; it may already be imported indirectly through dashboard modules. If storage is not directly imported, add it)
- Import { exportJobs } from './csv-exporter.js' (already added in Plan 01)
- Create a function showStorageWarning(usageStats):
  - Get the storage-warning div by ID
  - Set its style.display to 'flex'
  - Set its innerHTML to:
    ```
    <span class="warning-icon">&#9888;</span>
    <div class="warning-text">
      <strong>Storage ${usageStats.isCritical ? 'critically' : 'almost'} full (${usageStats.percentUsed}%)</strong>
      <span>${usageStats.megabytesUsed}MB of ${usageStats.megabytesQuota}MB used. ${usageStats.isCritical ? 'Extension may fail to save new data.' : 'Consider exporting and clearing old jobs.'}</span>
    </div>
    <div class="warning-actions">
      <button class="btn-warning-action" id="warning-export-btn">Export Jobs</button>
      <button class="btn-warning-action" id="warning-manage-btn">Manage Storage</button>
    </div>
    ```
  - Add click handler on warning-export-btn: calls exportJobs(), shows success/error feedback
  - Add click handler on warning-manage-btn: calls openSettings() (the existing function in popup.js)
  - Add 'critical' class to the banner div if usageStats.isCritical for different styling

- In the DOMContentLoaded handler, AFTER renderJobGrid() completes, add storage check:
  ```
  const usageStats = await storage.getStorageUsage();
  if (usageStats.shouldWarn) {
    showStorageWarning(usageStats);
  }
  ```

**src/popup.css:**
- Add .storage-warning styles:
  - display: flex (when visible), align-items: center, gap: 12px
  - Background: #3e2723 (dark brown/warning tone matching dark theme) for normal, #4a1010 (dark red) for .storage-warning.critical
  - Border: 1px solid #ff9800 for normal, 1px solid #f44336 for critical
  - Border-radius: 6px
  - Padding: 10px 14px
  - Margin: 0 0 8px 0 (space between banner and toolbar)
  - Font-size: 12px
  - Color: #fff

- .warning-icon: font-size 18px, flex-shrink 0
- .warning-text: flex 1, display flex, flex-direction column, gap 2px
- .warning-text strong: color #ff9800 (amber for normal), color #f44336 (red for critical)
- .warning-text span: color #ccc, font-size 11px
- .warning-actions: display flex, gap 6px, flex-shrink 0
- .btn-warning-action: background transparent, border 1px solid #ff9800, color #ff9800, padding 4px 10px, border-radius 4px, cursor pointer, font-size 11px
- .btn-warning-action:hover: background rgba(255,152,0,0.15)
- .storage-warning.critical .btn-warning-action: border-color #f44336, color #f44336
- .storage-warning.critical .btn-warning-action:hover: background rgba(244,67,54,0.15)

**src/settings.js:**
- In the existing settings initialization, add a "Storage Usage" section at the BOTTOM of the settings panel (after the existing Data Management section):
  - Create a section with heading "Storage Usage"
  - On section render, call storage.getStorageUsage() and display:
    - A progress bar showing percentage used (thin horizontal bar)
    - Text: "${megabytesUsed}MB of ${megabytesQuota}MB used (${percentUsed}%)"
    - If shouldWarn: add warning text in amber/red below the bar
  - Progress bar styling: height 6px, background #333, border-radius 3px, inner bar background #81c784 (green) when <60%, #ffd54f (amber) when 60-80%, #e57373 (red) when >80%
  - This provides visibility into storage usage even when below the 80% warning threshold
  </action>
  <verify>
Load the extension. Check that on popup open, if storage is below 80%, no warning banner appears but the settings panel shows the Storage Usage section with a progress bar. To test the warning banner: this would require significant data in storage (>8MB). Instead, verify the banner HTML/CSS exists by temporarily lowering the threshold in code or inspecting the DOM. Verify the settings panel shows the Storage Usage section at the bottom.
  </verify>
  <done>
Storage warning banner appears when usage exceeds 80%, shows percentage and MB used, has Export Jobs and Manage Storage action buttons that work. Critical state (>95%) shows red styling. Settings panel shows Storage Usage section with progress bar at all times. getStorageUsage() method works without crashing even on API errors.
  </done>
</task>

</tasks>

<verification>
1. Load extension in chrome://extensions (developer mode, reload)
2. Open popup -- verify no warning banner if storage is low
3. Open Settings -- scroll to bottom, verify Storage Usage section shows progress bar with current usage
4. Verify the progress bar color is appropriate for the usage level
5. To test warning banner: in DevTools console, temporarily modify the QUOTA_BYTES constant to a small value (e.g., 1024) in storage.js and reload -- verify warning banner appears
6. Verify warning banner Export Jobs button triggers CSV export
7. Verify warning banner Manage Storage button opens settings panel
8. Verify critical state (>95%) shows red styling variant
</verification>

<success_criteria>
- storage.getStorageUsage() returns accurate stats from getBytesInUse()
- Warning banner appears at 80% capacity with amber styling
- Critical banner appears at 95% with red styling
- Export Jobs button in banner triggers CSV download
- Manage Storage button opens settings panel
- Settings panel shows storage usage progress bar at all times
- Storage monitoring never crashes the app (graceful error handling)
</success_criteria>

<output>
After completion, create `.planning/phases/08-export-polish/08-02-SUMMARY.md`
</output>
