---
phase: 08-export-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/csv-exporter.js]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking Export CSV triggers file picker and downloads a valid CSV file"
    - "Export CSV button shows 'No jobs to export' when all visible jobs are dismissed or passed"
  artifacts:
    - path: "src/csv-exporter.js"
      provides: "Data URL download + dismissed/passed job filtering"
      contains: "data:text/csv"
  key_links:
    - from: "src/csv-exporter.js"
      to: "chrome.downloads.download()"
      via: "data URL (base64-encoded)"
      pattern: "data:text/csv;charset=utf-8;base64"
---

<objective>
Fix two UAT failures in CSV export: (1) download fails because blob URLs are incompatible with chrome.downloads.download() in Manifest V3, and (2) empty state validation counts dismissed/passed jobs that the user cannot see.

Purpose: These are the only two blocking issues preventing Phase 8 UAT sign-off. Fixing them unblocks 5 skipped tests.
Output: Working CSV export with correct empty-state behavior.
</objective>

<execution_context>
@/Users/udirno/.claude/get-shit-done/workflows/execute-plan.md
@/Users/udirno/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-export-polish/08-01-SUMMARY.md
@.planning/debug/csv-export-fails-export-failed.md
@src/csv-exporter.js
@src/dashboard/filters.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace blob URL with data URL in downloadCSV()</name>
  <files>src/csv-exporter.js</files>
  <action>
In src/csv-exporter.js, replace the downloadCSV() function (lines 101-123) to use a base64-encoded data URL instead of a blob URL.

The current approach fails because chrome.downloads.download() in Manifest V3 does not support blob URLs created with URL.createObjectURL(). This is a known Chrome bug/limitation.

Replace the function body with:
1. Convert the csvString to a base64-encoded data URL: `data:text/csv;charset=utf-8;base64,` + btoa(unescape(encodeURIComponent(csvString)))
   - The encodeURIComponent + unescape + btoa chain handles UTF-8 characters correctly for base64 encoding
2. Pass the data URL directly to chrome.downloads.download() with the same filename and saveAs: true options
3. Remove ALL blob-related code: no Blob constructor, no URL.createObjectURL(), no URL.revokeObjectURL(), no setTimeout cleanup
4. Keep the try/catch structure and error re-throw

The function signature and return type (Promise of downloadId) remain the same.
  </action>
  <verify>
Grep src/csv-exporter.js for "createObjectURL" — should return 0 matches.
Grep src/csv-exporter.js for "data:text/csv" — should return 1 match.
  </verify>
  <done>downloadCSV() uses a data URL that chrome.downloads.download() accepts in MV3, with no blob URL code remaining.</done>
</task>

<task type="auto">
  <name>Task 2: Filter dismissed and passed jobs before export validation</name>
  <files>src/csv-exporter.js</files>
  <action>
In src/csv-exporter.js, modify the exportJobs() function (lines 130-146) to filter out dismissed and passed jobs before the empty check.

Current code:
```js
const jobsMap = await storage.getJobs();
const jobs = Object.values(jobsMap);
if (jobs.length === 0) { throw new Error('No jobs to export'); }
```

The problem: storage.getJobs() returns ALL jobs including those with `dismissed: true` and `status: 'passed'`. The dashboard filters these out visually (see filters.js lines 63-76), but the export does not. When a user "deletes all jobs" via the UI, they are only marking them as dismissed, not removing them from storage. So the export still sees them and proceeds to export invisible jobs.

Change to:
```js
const jobsMap = await storage.getJobs();
const allJobs = Object.values(jobsMap);

// Filter out dismissed and passed jobs (matches dashboard visibility logic in filters.js)
const jobs = allJobs.filter(job => job.dismissed !== true && job.status !== 'passed');

if (jobs.length === 0) {
  throw new Error('No jobs to export');
}
```

This aligns export behavior with what the user sees on the dashboard. When all visible jobs have been dismissed or marked as passed, the export correctly reports "No jobs to export."

Do NOT change generateCSV() — it already handles whatever array it receives. The filtering happens only in exportJobs() before passing to generateCSV().
  </action>
  <verify>
Read src/csv-exporter.js exportJobs() function and confirm the filter line exists with `job.dismissed !== true && job.status !== 'passed'`.
  </verify>
  <done>exportJobs() filters out dismissed and passed jobs before validation, matching dashboard visibility. Empty state triggers correctly when user has no visible jobs.</done>
</task>

</tasks>

<verification>
1. Grep src/csv-exporter.js for "createObjectURL" — 0 matches (blob URL removed)
2. Grep src/csv-exporter.js for "data:text/csv" — 1 match (data URL implemented)
3. Grep src/csv-exporter.js for "dismissed" — 1 match (filter in exportJobs)
4. Grep src/csv-exporter.js for "passed" — 1 match (filter in exportJobs)
5. Read exportJobs() to confirm filter comes before empty check
</verification>

<success_criteria>
- downloadCSV() uses base64 data URL instead of blob URL
- exportJobs() filters dismissed and passed jobs before validation
- No blob URL code remains in csv-exporter.js
- Both UAT test 2 (CSV export download) and test 4 (empty state) are addressed
</success_criteria>

<output>
After completion, create `.planning/phases/08-export-polish/08-03-SUMMARY.md`
</output>
